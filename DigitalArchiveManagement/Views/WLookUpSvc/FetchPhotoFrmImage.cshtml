
@{
    ViewData["Title"] = "裁剪本地图片取利用者头像";
}


@section head {
    <link href="~/lib/jquery-cropper/cropper.min.css" rel="stylesheet" />
    <link href="~/css/cropper.css" rel="stylesheet" />
}

@section body {

    <div class="container-fluid">
        <div class="row" style="margin-top:12px;">
            <div class="col-md-8">
                <div class="img-container">
                    <img src="~/images/cropping.jpg" alt="Picture">
                </div>

            </div>
            <div class="col-md-4">
                <div class="docs-preview clearfix">
                    <div class="img-preview preview-lg"></div>
                    <div class="img-preview preview-md"></div>
                    <div class="img-preview preview-sm"></div>
                    <div class="img-preview preview-xs"></div>
                </div>

            </div>
        </div>
        <div class="row">
            <div class="col-md-8 docs-buttons">
                <div class="btn-group">
                    <button class="btn btn-default" data-method="setDragMode" data-option="move" type="button" title="Move">
                        <span class="docs-tooltip" data-toggle="tooltip" title="移动图片模式">
                            <span class="fa fa-arrows"></span>
                        </span>
                    </button>
                    <button class="btn btn-default" data-method="setDragMode" data-option="crop" type="button" title="Crop">
                        <span class="docs-tooltip" data-toggle="tooltip" title="移动裁剪框模式">
                            <span class="fa fa-crop"></span>
                        </span>
                    </button>
                    <button class="btn btn-default" data-method="zoom" data-option="0.1" type="button" title="Zoom In">
                        <span class="docs-tooltip" data-toggle="tooltip" title="放大图片">
                            <span class="fa fa-search-plus "></span>
                        </span>
                    </button>
                    <button class="btn btn-default" data-method="zoom" data-option="-0.1" type="button" title="Zoom Out">
                        <span class="docs-tooltip" data-toggle="tooltip" title="缩小图片">
                            <span class="fa fa-search-minus"></span>
                        </span>
                    </button>
                    <button class="btn btn-default" data-method="rotate" data-option="-45" type="button" title="Rotate Left">
                        <span class="docs-tooltip" data-toggle="tooltip" title="左旋转45度">
                            <span class="fa fa-rotate-left"></span>
                        </span>
                    </button>
                    <button class="btn btn-default" data-method="rotate" data-option="45" type="button" title="Rotate Right">
                        <span class="docs-tooltip" data-toggle="tooltip" title="右旋转45度">
                            <span class="fa fa-rotate-right"></span>
                        </span>
                    </button>
                </div>

                <div class="btn-group">
                    <button class="btn btn-default" data-method="disable" type="button" title="Disable">
                        <span class="docs-tooltip" data-toggle="tooltip" title="锁定图片和裁剪框">
                            <span class="fa fa-lock"></span>
                        </span>
                    </button>
                    <button class="btn btn-default" data-method="enable" type="button" title="Enable">
                        <span class="docs-tooltip" data-toggle="tooltip" title="解锁图片和裁剪框">
                            <span class="fa fa-unlock"></span>
                        </span>
                    </button>
                    <button class="btn btn-default" data-method="clear" type="button" title="Clear">
                        <span class="docs-tooltip" data-toggle="tooltip" title="删除现有选择状态">
                            <span class="fa fa-remove"></span>
                        </span>
                    </button>
                    <button class="btn btn-default" data-method="reset" type="button" title="Reset">
                        <span class="docs-tooltip" data-toggle="tooltip" title="还原图片和裁剪框为初始状态">
                            <span class="fa fa-refresh"></span>
                        </span>
                    </button>

                    @*<button class="btn btn-default" data-method="destroy" type="button" title="Destroy">
                        <span class="docs-tooltip" data-toggle="tooltip" title="关闭本裁剪总窗口">
                            <span class="fa fa-power-off"></span>
                        </span>
                    </button>*@
                </div>

                <div class="btn-group btn-group-crop">
                    <label class="btn btn-default btn-upload" for="inputImage" title="Upload image file">
                        <input class="sr-only" id="inputImage" name="file" type="file" accept="image/*">
                        <span class="docs-tooltip" data-toggle="tooltip" title="选择自定义图片">
                            <span class="fa fa-upload"></span>
                            上传图片
                        </span>
                    </label>
                    <button class="btn btn-default" data-method="getCroppedCanvas" type="button">
                        <span class="docs-tooltip" data-toggle="tooltip" title="点击以确认裁剪">
                            <span class="fa fa-cut"></span>
                            确认裁剪
                        </span>
                    </button>
                    @*<button class="btn btn-default" data-method="getCroppedCanvas" data-option="{ &quot;width&quot;: 160, &quot;height&quot;: 90 }" type="button">
                        <span class="docs-tooltip" data-toggle="tooltip" title="裁剪为长160宽90的图片">
                            160 &times; 90
                        </span>
                    </button>
                    <button class="btn btn-default" data-method="getCroppedCanvas" data-option="{ &quot;width&quot;: 320, &quot;height&quot;: 180 }" type="button">
                        <span class="docs-tooltip" data-toggle="tooltip" title="裁剪为长320宽180的图片">
                            320 &times; 180
                        </span>
                    </button>*@
                </div>
            </div>
            <div class="col-md-4 docs-toggles">
                <div class="btn-group btn-group-justified" data-toggle="buttons">
                    <label class="btn btn-default active" data-method="setAspectRatio" data-option="1.7777777777777777" title="Set Aspect Ratio">
                        <input class="sr-only" id="aspestRatio1" name="aspestRatio" value="1.7777777777777777" type="radio">
                        <span class="docs-tooltip" data-toggle="tooltip" title="保持裁剪框比例为16:9">
                            16:9
                        </span>
                    </label>
                    <label class="btn btn-default" data-method="setAspectRatio" data-option="1.3333333333333333" title="Set Aspect Ratio">
                        <input class="sr-only" id="aspestRatio2" name="aspestRatio" value="1.3333333333333333" type="radio">
                        <span class="docs-tooltip" data-toggle="tooltip" title="保持裁剪框比例为4:3">
                            4:3
                        </span>
                    </label>
                    <label class="btn btn-default" data-method="setAspectRatio" data-option="1" title="Set Aspect Ratio">
                        <input class="sr-only" id="aspestRatio3" name="aspestRatio" value="1" type="radio">
                        <span class="docs-tooltip" data-toggle="tooltip" title="保持裁剪框比例为1:1">
                            1:1
                        </span>
                    </label>
                    <label class="btn btn-default" data-method="setAspectRatio" data-option="0.6666666666666666" title="Set Aspect Ratio">
                        <input class="sr-only" id="aspestRatio4" name="aspestRatio" value="0.6666666666666666" type="radio">
                        <span class="docs-tooltip" data-toggle="tooltip" title="保持裁剪框比例为2:3">
                            2:3
                        </span>
                    </label>
                    <label class="btn btn-default" data-method="setAspectRatio" data-option="NaN" title="Set Aspect Ratio">
                        <input class="sr-only" id="aspestRatio5" name="aspestRatio" value="NaN" type="radio">
                        <span class="docs-tooltip" data-toggle="tooltip" title="自定义裁剪框比例">
                            自由
                        </span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(function () {

            'use strict';

            var console = window.console || { log: function () { } };
                //$alert = $('.docs-alert'),
                //$message = $alert.find('.message'),
                //showMessage = function (message, type) {
                //    $message.text(message);

                //    if (type) {
                //        $message.addClass(type);
                //    }

                //    $alert.fadeIn();

                //    setTimeout(function () {
                //        $alert.fadeOut();
                //    }, 3000);
                //};

            // Demo
            // -------------------------------------------------------------------------

            (function () {
                var $image = $('.img-container > img'),
                    //$dataX = $('#dataX'),
                    //$dataY = $('#dataY'),
                    //$dataHeight = $('#dataHeight'),
                    //$dataWidth = $('#dataWidth'),
                    //$dataRotate = $('#dataRotate'),
                    options = {
                        // strict: false,
                        // responsive: false,
                        // checkImageOrigin: false

                        // modal: false,
                        // guides: false,
                        // highlight: false,
                        // background: false,

                        // autoCrop: false,
                        // autoCropArea: 0.5,
                        // dragCrop: false,
                        // movable: false,
                        // resizable: false,
                        // rotatable: false,
                        // zoomable: false,
                        // touchDragZoom: false,
                        // mouseWheelZoom: false,

                        // minCanvasWidth: 320,
                        // minCanvasHeight: 180,
                        // minCropBoxWidth: 160,
                        // minCropBoxHeight: 90,
                        // minContainerWidth: 320,
                        // minContainerHeight: 180,

                        // build: null,
                        // built: null,
                        // dragstart: null,
                        // dragmove: null,
                        // dragend: null,
                        // zoomin: null,
                        // zoomout: null,

                        aspectRatio: 16 / 9,
                        preview: '.img-preview',
                        crop: function (data) {
                            //$dataX.val(Math.round(data.x));
                            //$dataY.val(Math.round(data.y));
                            //$dataHeight.val(Math.round(data.height));
                            //$dataWidth.val(Math.round(data.width));
                            //$dataRotate.val(Math.round(data.rotate));
                        }
                    };

                $image.on({
                    'build.cropper': function (e) {
                        console.log(e.type);
                    },
                    'built.cropper': function (e) {
                        console.log(e.type);
                    },
                    'dragstart.cropper': function (e) {
                        console.log(e.type, e.dragType);
                    },
                    'dragmove.cropper': function (e) {
                        console.log(e.type, e.dragType);
                    },
                    'dragend.cropper': function (e) {
                        console.log(e.type, e.dragType);
                    },
                    'zoomin.cropper': function (e) {
                        console.log(e.type);
                    },
                    'zoomout.cropper': function (e) {
                        console.log(e.type);
                    }
                }).cropper(options);


                // Methods
                $(document.body).on('click', '[data-method]', function () {
                    var data = $(this).data(),
                        $target,
                        result;

                    if (data.method) {
                        data = $.extend({}, data); // Clone a new one

                        if (typeof data.target !== 'undefined') {
                            $target = $(data.target);

                            if (typeof data.option === 'undefined') {
                                try {
                                    data.option = JSON.parse($target.val());
                                } catch (e) {
                                    console.log(e.message);
                                }
                            }
                        }

                        result = $image.cropper(data.method, data.option);

                        if (data.method === 'getCroppedCanvas') {
                            //$('#getCroppedCanvasModal').modal().find('.modal-body').html(result);
                            var strDataURI = result.toDataURL("image/png"); 
                            $('#webcam', parent.document).attr('src', strDataURI);//在父窗口img中显示图片
                            //saveToImage(Imagedata);//保存到后台
                        }

                        if ($.isPlainObject(result) && $target) {
                            try {
                                $target.val(JSON.stringify(result));
                            } catch (e) {
                                console.log(e.message);
                            }
                        }

                    }
                }).on('keydown', function (e) {

                    switch (e.which) {
                        case 37:
                            e.preventDefault();
                            $image.cropper('move', -1, 0);
                            break;

                        case 38:
                            e.preventDefault();
                            $image.cropper('move', 0, -1);
                            break;

                        case 39:
                            e.preventDefault();
                            $image.cropper('move', 1, 0);
                            break;

                        case 40:
                            e.preventDefault();
                            $image.cropper('move', 0, 1);
                            break;
                    }

                });


                // Import image
                var $inputImage = $('#inputImage'),
                    URL = window.URL || window.webkitURL,
                    blobURL;

                if (URL) {
                    $inputImage.change(function () {
                        var files = this.files,
                            file;

                        if (files && files.length) {
                            file = files[0];

                            if (/^image\/\w+$/.test(file.type)) {
                                blobURL = URL.createObjectURL(file);
                                $image.one('built.cropper', function () {
                                    URL.revokeObjectURL(blobURL); // Revoke when load complete
                                }).cropper('reset', true).cropper('replace', blobURL);
                                $inputImage.val('');
                            } else {
                                showMessage('Please choose an image file.');
                            }
                        }
                    });
                } else {
                    $inputImage.parent().remove();
                }


                // Options
                $('.docs-options :checkbox').on('change', function () {
                    var $this = $(this);

                    options[$this.val()] = $this.prop('checked');
                    $image.cropper('destroy').cropper(options);
                });


                // Tooltips
                $('[data-toggle="tooltip"]').tooltip();

            }());

        });

        $("#h_loading_mask").css("display", "none");
        $("#h_loading").css("display", "none");
        var saveToImage = function (imgdata) {
            $.ajax({
                type: 'POST',
                url: "/WLookUpSvc/Capture",
                data: { imgData: imgdata },
                dataType: "JSON",
                success: function (data) {
                    //HM.hintWin('成功！');
                }
            });
        }

    </script>
}

@section script {
    <script src="~/lib/jquery-cropper/cropper.min.js"></script>
    <script src="~/lib/modal-panel/pop.min.js"></script>
    <script src="~/js/modalwindow.js"></script>
}



